import React, { useState, useEffect, useMemo, useRef } from 'react';
import { ShoppingCart, User, Phone, Send, CheckCircle, Plus, Minus, Store, ChevronRight } from 'lucide-react';

// 表單設定與商品資料
const FORM_ACTION = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSdimgv8vtLEzCgBkfr2kBwuow4klWgnJ50yZMGnO1djQXCl_Q/formResponse";

const CATEGORIES = [
    {
        id: "cat1",
        title: "花生、瓜子類",
        items: [
            { id: "entry.404970610", name: "棗子夾綜合堅果 (半斤)", price: 270 },
            { id: "entry.1921963703", name: "椰棗夾核桃 (半斤)", price: 270 },
            { id: "entry.787277546", name: "紅棗夾核桃 (半斤)", price: 270 },
            { id: "entry.679944918", name: "開心果 (半斤)", price: 200 },
            { id: "entry.1780970911", name: "開心果 (斤)", price: 380 },
            { id: "entry.47766615", name: "焦糖葵瓜子 (斤)", price: 140 },
            { id: "entry.1298195063", name: "紅棗葵瓜子 (斤)", price: 150 },
            { id: "entry.1454250353", name: "花生酥心糖 (半斤)", price: 100 },
            { id: "entry.834742509", name: "黑芝麻酥心糖 (半斤)", price: 100 },
            { id: "entry.1099207724", name: "帶殼杏仁果 (斤)", price: 280 },
            { id: "entry.1087419734", name: "黑金剛花生 (斤)", price: 200 },
            { id: "entry.1683800184", name: "甜香園南棗核桃糕 (1kg)", price: 350 },
            { id: "entry.1948447066", name: "綜合蔬果脆片 (包)", price: 140 },
            { id: "entry.1140163057", name: "烘焙綜合堅果(四寶) (400g)", price: 350 },
        ]
    },
    {
        id: "cat2",
        title: "香菇蜜餞類",
        items: [
            { id: "entry.1202668894", name: "埔里中香菇 (150g)", price: 400 },
            { id: "entry.399025024", name: "台灣芭樂乾 (包)", price: 140 },
            { id: "entry.1187706279", name: "台灣芒果乾 (包)", price: 240 },
            { id: "entry.1999192391", name: "台灣情人果 (包)", price: 190 },
            { id: "entry.395188003", name: "台灣紅心芭樂 (包)", price: 190 },
            { id: "entry.1808106998", name: "蜜柑橘瓣 (包)", price: 190 },
            { id: "entry.691277056", name: "香橙桔片 (包)", price: 140 },
            { id: "entry.1771549261", name: "台灣草莓乾 (包)", price: 140 },
            { id: "entry.1515496860", name: "台灣水蜜桃 (包)", price: 190 },
            { id: "entry.1466511016", name: "蒜味豬肉條 (半斤)", price: 300 },
            { id: "entry.1035175677", name: "梅有芒果 (包)", price: 150 },
            { id: "entry.455347466", name: "泰國芒果乾 (半斤)", price: 180 },
            { id: "entry.1786986181", name: "龜苓膏軟糖 (半斤)", price: 100 },
            { id: "entry.376791054", name: "蜜汁筷豬肉條子 (半斤)", price: 260 },
        ]
    },
    {
        id: "cat3",
        title: "花生零嘴類",
        items: [
            { id: "entry.1832555164", name: "一口烏魚子 (100g)", price: 450 },
            { id: "entry.1082846740", name: "特級烏魚子 (5兩)", price: 600 },
            { id: "entry.70616302", name: "厚撕魷魚絲 (半斤)", price: 320 },
            { id: "entry.1022651447", name: "鮪魚糖 (250g)", price: 180 },
            { id: "entry.923118669", name: "麻辣鱈魚切片 (250g)", price: 180 },
            { id: "entry.387722961", name: "起司豬肉乾 (半斤)", price: 320 },
            { id: "entry.1416263078", name: "杏仁小魚乾 (半斤)", price: 300 },
            { id: "entry.1154214828", name: "黑芝麻夾心鱈魚絲 (250g)", price: 180 },
            { id: "entry.95167453", name: "昆布糖 (250g)", price: 200 },
            { id: "entry.1775553691", name: "炭烤魷魚絲 (半斤)", price: 320 },
            { id: "entry.1008059188", name: "原味魷魚絲 (半斤)", price: 320 },
            { id: "entry.794171043", name: "炭烤魷魚片 (半斤)", price: 320 },
        ]
    }
];

export default function App() {
    const [quantities, setQuantities] = useState({});
    const [customerName, setCustomerName] = useState("");
    const [customerPhone, setCustomerPhone] = useState("");
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSubmitted, setIsSubmitted] = useState(false);
    const [activeCategory, setActiveCategory] = useState("cat1");
    const iframeRef = useRef(null);
    const formRef = useRef(null);

    // 計算總價
    const totalAmount = useMemo(() => {
        let total = 0;
        CATEGORIES.forEach(cat => {
            cat.items.forEach(item => {
                const qty = quantities[item.id] || 0;
                total += qty * item.price;
            });
        });
        return total;
    }, [quantities]);

    // 計算總數量
    const totalItems = useMemo(() => {
        let count = 0;
        Object.values(quantities).forEach(q => count += (q || 0));
        return count;
    }, [quantities]);

    // 處理數量變更
    const handleQuantityChange = (id, delta) => {
        setQuantities(prev => {
            const current = prev[id] || 0;
            const next = Math.max(0, current + delta);
            return { ...prev, [id]: next };
        });
    };
    
    // 直接輸入數量
    const handleManualQuantity = (id, value) => {
        const val = parseInt(value);
        if (!isNaN(val) && val >= 0) {
            setQuantities(prev => ({ ...prev, [id]: val }));
        } else if (value === "") {
            setQuantities(prev => ({ ...prev, [id]: 0 }));
        }
    };

    // 處理送出
    const handleSubmit = (e) => {
        e.preventDefault();
        if (!customerName.trim() || !customerPhone.trim()) {
            alert("請填寫姓名與電話");
            // 滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        if (totalItems === 0) {
            alert("您尚未選擇任何商品");
            return;
        }

        setIsSubmitting(true);
        
        // 提交表單
        if (formRef.current) {
            formRef.current.submit();
        }
    };

    // 監聽 iframe載入，判斷是否送出成功
    const handleIframeLoad = () => {
        if (isSubmitting) {
            setIsSubmitted(true);
            setIsSubmitting(false);
            window.scrollTo(0, 0);
        }
    };

    // 滾動監聽以更新導覽列
    useEffect(() => {
        const handleScroll = () => {
            const scrollPosition = window.scrollY + 200;
            
            for (const cat of CATEGORIES) {
                const element = document.getElementById(cat.id);
                if (element && element.offsetTop <= scrollPosition && (element.offsetTop + element.offsetHeight) > scrollPosition) {
                    setActiveCategory(cat.id);
                }
            }
        };
        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
    }, []);

    const scrollToCategory = (id) => {
        const element = document.getElementById(id);
        if (element) {
            const offset = 80; // Header height adjustment
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;
            window.scrollTo({
                top: offsetPosition,
                behavior: "smooth"
            });
        }
    };

    if (isSubmitted) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-green-50 font-sans">
                <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full border border-green-100">
                    <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <CheckCircle size={40} strokeWidth={3} />
                    </div>
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">訂購成功！</h2>
                    <p className="text-gray-600 mb-6">謝謝您的訂購，我們已收到您的訂單。</p>
                    <div className="bg-gray-50 p-4 rounded-xl text-left mb-6 text-sm text-gray-500">
                        <p>訂購人：{customerName}</p>
                        <p>總金額：${totalAmount}</p>
                    </div>
                    <button 
                        onClick={() => window.location.reload()}
                        className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-green-200"
                    >
                        再填寫一筆
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen pb-24 bg-[#fcf8f2] font-sans">
            {/* 隱藏的 iframe 用於處理表單提交而不跳轉 */}
            <iframe 
                name="hidden_iframe" 
                id="hidden_iframe" 
                ref={iframeRef}
                style={{ display: 'none' }} 
                onLoad={handleIframeLoad}
            ></iframe>

            {/* 頂部標題 */}
            <header className="bg-white shadow-sm sticky top-0 z-50">
                <div className="bg-orange-600 text-white py-4 px-4 shadow-md">
                    <div className="max-w-3xl mx-auto flex items-center gap-3">
                        <Store className="shrink-0" />
                        <div>
                            <h1 className="text-xl font-bold leading-tight">115 弘森食品行</h1>
                            <p className="text-xs text-orange-100 opacity-90 mt-1">請直接輸入數量，價格規格如標示</p>
                        </div>
                    </div>
                </div>
                {/* 分類導航 */}
                <div className="overflow-x-auto whitespace-nowrap bg-white border-b border-gray-100 px-2 hide-scrollbar">
                    <div className="max-w-3xl mx-auto flex">
                        {CATEGORIES.map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => scrollToCategory(cat.id)}
                                className={`px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
                                    activeCategory === cat.id 
                                    ? 'text-orange-600 border-orange-600' 
                                    : 'text-gray-500 border-transparent hover:text-gray-800'
                                }`}
                            >
                                {cat.title}
                            </button>
                        ))}
                    </div>
                </div>
            </header>

            <div className="max-w-3xl mx-auto p-4 space-y-6 mt-4">
                {/* 真實表單 (隱藏與顯示的 Input 混合) */}
                <form 
                    ref={formRef}
                    action={FORM_ACTION} 
                    method="POST" 
                    target="hidden_iframe"
                    className="space-y-6"
                >
                    {/* 個人資料區塊 */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                        <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-2">
                            <User size={20} className="text-orange-500" /> 訂購資訊 <span className="text-red-500 text-sm">*必填</span>
                        </h2>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">訂購人姓名 <span className="text-red-500">*</span></label>
                            <input 
                                type="text" 
                                name="entry.1886328166" 
                                required
                                value={customerName}
                                onChange={e => setCustomerName(e.target.value)}
                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none transition-all bg-gray-50 focus:bg-white"
                                placeholder="請輸入您的姓名"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">聯絡電話 <span className="text-red-500">*</span></label>
                            <input 
                                type="tel" 
                                name="entry.1513847519" 
                                required
                                value={customerPhone}
                                onChange={e => setCustomerPhone(e.target.value)}
                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none transition-all bg-gray-50 focus:bg-white"
                                placeholder="請輸入聯絡電話"
                            />
                        </div>
                    </div>

                    {/* 商品列表 */}
                    {CATEGORIES.map(cat => (
                        <section key={cat.id} id={cat.id} className="scroll-mt-32">
                            <div className="flex items-center gap-2 mb-4 mt-8 px-1">
                                <div className="h-6 w-1 bg-orange-500 rounded-full"></div>
                                <h3 className="text-xl font-bold text-gray-800">{cat.title}</h3>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {cat.items.map(item => (
                                    <div key={item.id} className={`bg-white p-4 rounded-xl shadow-sm border transition-all ${quantities[item.id] > 0 ? 'border-orange-300 ring-1 ring-orange-100' : 'border-gray-100'}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <h4 className="font-bold text-gray-800 text-lg leading-tight mb-1">{item.name}</h4>
                                                <span className="inline-block bg-orange-50 text-orange-700 text-sm px-2 py-0.5 rounded-md font-medium">
                                                    ${item.price}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center justify-end gap-3 mt-2">
                                            <button 
                                                type="button"
                                                onClick={() => handleQuantityChange(item.id, -1)}
                                                className={`w-9 h-9 flex items-center justify-center rounded-full border transition-colors ${quantities[item.id] > 0 ? 'border-orange-200 text-orange-600 bg-orange-50 active:bg-orange-200' : 'border-gray-200 text-gray-300 cursor-not-allowed'}`}
                                                disabled={!quantities[item.id]}
                                            >
                                                <Minus size={16} strokeWidth={3} />
                                            </button>
                                            
                                            {/* 隱藏的 Input 實際送出資料，顯示的 Input 用於 UI */}
                                            <input 
                                                type="number" 
                                                name={item.id} // Google Form Entry ID
                                                value={quantities[item.id] || ""} // 空字串避免送出 "0"
                                                readOnly
                                                className="hidden"
                                            />

                                            <input 
                                                type="text" 
                                                inputMode="numeric"
                                                className="w-12 text-center text-xl font-bold text-gray-800 outline-none border-b border-transparent focus:border-orange-500 p-0"
                                                value={quantities[item.id] || 0}
                                                onChange={(e) => handleManualQuantity(item.id, e.target.value)}
                                            />

                                            <button 
                                                type="button"
                                                onClick={() => handleQuantityChange(item.id, 1)}
                                                className="w-9 h-9 flex items-center justify-center rounded-full bg-orange-500 text-white shadow-md shadow-orange-200 active:bg-orange-600 active:shadow-none transition-all"
                                            >
                                                <Plus size={16} strokeWidth={3} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    ))}
                </form>
            </div>

            {/* 底部浮動結帳列 */}
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] p-4 z-40 safe-bottom">
                <div className="max-w-3xl mx-auto flex items-center justify-between gap-4">
                    <div className="flex flex-col">
                        <span className="text-xs text-gray-500">總計 {totalItems} 件商品</span>
                        <div className="flex items-baseline gap-1">
                            <span className="text-sm font-medium text-orange-600">$</span>
                            <span className="text-2xl font-extrabold text-gray-900">{totalAmount}</span>
                        </div>
                    </div>
                    <button 
                        onClick={handleSubmit}
                        disabled={isSubmitting || totalItems === 0}
                        className={`flex items-center gap-2 px-8 py-3 rounded-full font-bold text-lg shadow-lg transition-all transform active:scale-95 ${
                            isSubmitting 
                            ? 'bg-gray-400 text-white cursor-not-allowed' 
                            : totalItems > 0
                                ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-orange-200 hover:shadow-orange-300'
                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                        }`}
                    >
                        {isSubmitting ? (
                            <>處理中...</>
                        ) : (
                            <>
                                送出訂單 <ChevronRight size={20} />
                            </>
                        )}
                    </button>
                </div>
            </div>
            
            <style>{`
                .safe-bottom {
                    padding-bottom: env(safe-area-inset-bottom, 1rem);
                }
                .hide-scrollbar::-webkit-scrollbar { display: none; }
                .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            `}</style>
        </div>
    );
};
